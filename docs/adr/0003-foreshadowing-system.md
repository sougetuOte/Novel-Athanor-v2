# ADR-0003: 伏線管理システム（Chekhov's Gun Tracker）

## メタ情報
| 項目 | 内容 |
|------|------|
| ステータス | Accepted |
| 日付 | 2026-01-24 |
| 意思決定者 | プロジェクトオーナー |
| 関連ADR | [ADR-0002](./0002-ai-visibility-system.md) |

## コンテキスト

### 背景
解析した3プロジェクト（Novel-Athanor、NovelWriter、302_novel_writing）のいずれも、伏線管理機能を持っていなかった。長編小説において伏線の管理は重要であり、これを新規機能として実装することで差別化を図る。

「チェーホフの銃」の原則：物語に登場した要素は、後で使われなければならない。この原則を追跡・管理するシステムを構築する。

### 制約条件
- 伏線は「設置」「育成」「回収」のライフサイクルを持つ
- AIは伏線の存在を適切なタイミングで認識する必要がある
- 回収忘れを防止する仕組みが必要

### 要求事項
- 伏線の登録・追跡・回収管理
- 微細度（Subtlety）スケールによる伏線の強さ制御
- AI可視性システム（ADR-0002）との連携
- 回収期限のリマインド機能

## 検討した選択肢

### Option A: シンプルなタグ管理
**概要**: 伏線に「未回収」「回収済み」のタグを付けるだけ

**メリット**:
- 実装が容易
- 理解しやすい

**デメリット**:
- 伏線の「強さ」が管理できない
- 育成フェーズの概念がない

### Option B: ステート管理 + 微細度スケール
**概要**: 状態遷移 + 1-10 の微細度スケールで伏線を管理

**メリット**:
- 伏線の強弱を表現可能
- 育成フェーズを管理可能

**デメリット**:
- AI可視性との連携が手動

### Option C: Chekhov's Gun Tracker（完全版）
**概要**: 状態管理 + 微細度 + AI可視性自動連携 + 回収期限管理

| 状態 | 説明 | デフォルト可視性 |
|------|------|-----------------|
| planted | 設置済み | Level 1（認識のみ） |
| growing | 育成中 | Level 2（内容認識） |
| ready | 回収可能 | Level 3（使用可能） |
| harvested | 回収完了 | Level 3 |
| abandoned | 放棄 | Level 0（完全秘匿） |

**メリット**:
- 完全なライフサイクル管理
- AI可視性との自動連携
- 回収忘れ防止

**デメリット**:
- 実装複雑度が最も高い

## 3 Agents Analysis

### [Affirmative] 推進者の視点
> 最高の結果はどうなるか？どうすれば実現できるか？

- 伏線管理は他のどの小説生成AIにもない独自機能
- 長編小説で最も価値を発揮する「キラー機能」になりうる
- 微細度スケール（1-10）で伏線の「匂わせ度」を制御できる
- AI可視性と連携すれば、伏線の自然な成長を自動化できる

### [Critical] 批判者の視点
> 最悪の場合どうなるか？何が壊れるか？

- 機能過多で使いこなせない
- 微細度1-10は粒度が細かすぎる
- 自動連携が複雑でバグの温床になる
- ユーザーが伏線登録を面倒に感じて使わない

### [Mediator] 調停者の視点
> 今、我々が取るべき最善のバランスは何か？

- Option C を採用するが、段階的に実装
- Phase 1: 基本的な状態管理のみ
- Phase 2: 微細度スケール追加
- Phase 3: AI可視性自動連携
- 微細度は 1-10 だが、プリセット（低/中/高）も用意

## 決定

**採用**: Option C（Chekhov's Gun Tracker 完全版）

### 決定理由
- プロジェクトの最大の差別化ポイント
- 長編小説での実用性が高い
- AI可視性システムと組み合わせることで相乗効果

### 却下理由
- **Option A**: 伏線の繊細な扱いができない
- **Option B**: AI可視性との連携が不十分

## 影響

### ポジティブな影響
- 競合にない独自機能として差別化
- 長編小説の品質向上に直接貢献
- 作家のワークフローを効率化

### ネガティブな影響
- 実装の複雑さ（緩和策: 段階的実装）
- 学習コスト（緩和策: プリセットとチュートリアル）

### 影響を受けるコンポーネント
- `docs/specs/novel-generator-v2/05_foreshadowing-system.md`: 仕様定義済み
- `src/core/foreshadowing/`: 実装予定
- Continuity Director エージェント: 伏線追跡を担当

## 実装計画

### フェーズ1: 基本機能
- [ ] Foreshadow データモデル
- [ ] 状態遷移（planted → growing → ready → harvested）
- [ ] 基本 CRUD 操作

### フェーズ2: 微細度スケール
- [ ] Subtlety スケール（1-10）実装
- [ ] プリセット（低=1-3, 中=4-6, 高=7-10）

### フェーズ3: AI連携
- [ ] AI可視性との自動連携
- [ ] 回収期限リマインド
- [ ] ダッシュボード

## 検証方法
- 伏線の状態遷移が正しく行われることを確認
- 回収忘れがリマインドされることを確認
- AI が微細度に応じた「匂わせ」を行えることを確認

## 参考資料
- `docs/specs/novel-generator-v2/05_foreshadowing-system.md`: 詳細仕様
- チェーホフの銃: https://ja.wikipedia.org/wiki/チェーホフの銃
