# Novel-Athanor 機能フロー解析レポート

**Phase**: 1.3 機能フロー解析
**対象**: `.claude/agents/`, `.claude/commands/`, `.claude/skills/`
**日時**: 2026-01-24

---

## 1. コンポーネント概要

### 1.1 アーキテクチャ構成

```
┌─────────────────────────────────────────────────────────────┐
│                     User Interface                          │
├─────────────────────────────────────────────────────────────┤
│  Commands (スラッシュコマンド)                               │
│  ├─ /draft-scene     - 下書き生成（軽量I/F）                │
│  ├─ /count-chars     - 文字数カウント                       │
│  ├─ /focus           - タスク集中                          │
│  └─ ...                                                     │
└─────────────────────────────────────────────────────────────┘
                              ↓ 委譲
┌─────────────────────────────────────────────────────────────┐
│                     Agents (エージェント)                   │
├─────────────────────────────────────────────────────────────┤
│  ├─ draft-scene          - 下書き生成（本体処理）          │
│  ├─ check-consistency    - 整合性チェック                  │
│  ├─ create-plot          - プロット作成                    │
│  ├─ extract-summary      - サマリ抽出                      │
│  ├─ extract-character    - キャラクター設定抽出            │
│  ├─ extract-world        - 世界観設定抽出                  │
│  ├─ analyze-style        - 文体分析                        │
│  ├─ three-agents-review  - 3視点レビュー                   │
│  └─ ...                                                     │
└─────────────────────────────────────────────────────────────┘
                              ↓ 参照
┌─────────────────────────────────────────────────────────────┐
│                     Skills (知識ベース)                     │
├─────────────────────────────────────────────────────────────┤
│  ├─ plot-theories        - プロット理論                    │
│  ├─ character-theories   - キャラクター理論                │
│  ├─ style-guidelines     - 文体ガイドライン                │
│  ├─ quality-standards    - 品質基準                        │
│  └─ consistency-checker  - 整合性チェック基準              │
└─────────────────────────────────────────────────────────────┘
                              ↓ 操作
┌─────────────────────────────────────────────────────────────┐
│                     Data Layer (vault/)                     │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 コンポーネント関係

| コンポーネント | 役割 | 特徴 |
|--------------|------|------|
| **Commands** | ユーザーI/F | 軽量、引数解析、エージェントへ委譲 |
| **Agents** | 本体処理 | 自然言語で呼び出し可能、Skills参照 |
| **Skills** | 知識ベース | 自動適用、参照専用 |
| **Protocols** | 処理規約 | AoT など処理フレームワーク |

---

## 2. エージェント一覧

### 2.1 創作支援エージェント

| エージェント | 機能 | Skills | 起動トリガー |
|-------------|------|--------|-------------|
| `draft-scene` | 下書き生成 | plot, character, style | 「下書きを書いて」 |
| `create-plot` | プロット作成(L1/L2/L3) | plot | 「プロットを作成して」 |
| `extract-summary` | サマリ抽出(L1/L2/L3) | plot | 「サマリを抽出して」 |
| `extract-character` | キャラ設定抽出 | character | 「キャラ設定を抽出して」 |
| `extract-world` | 世界観設定抽出 | - | 「世界観設定を抽出して」 |
| `create-style-guide` | 文体ガイド作成 | style | 「スタイルガイドを作成して」 |
| `analyze-style` | 文体分析 | style | 「文体を分析して」 |
| `compare-plot-summary` | Plot/Summary比較 | plot | 「計画と実績を比較して」 |

### 2.2 品質管理エージェント

| エージェント | 機能 | Skills | 起動トリガー |
|-------------|------|--------|-------------|
| `check-consistency` | 整合性チェック | consistency, quality | 「整合性をチェックして」 |
| `three-agents-review` | 3視点分析 | quality | 「3視点で分析して」 |
| `impact-analysis` | 影響分析 | - | 「影響を分析して」 |
| `security-review` | セキュリティレビュー | - | 「セキュリティを確認して」 |

### 2.3 エージェントモード

多くのエージェントは3つのモードに対応:

| モード | トリガー | 動作 |
|-------|---------|------|
| **全自動** | デフォルト | 最適な結果を1つ生成 |
| **複数案** | 「3パターン」「複数案」 | 異なるアプローチで複数生成 |
| **ガイド付き** | 「コメディ調で」等 | 指定方向性に沿って生成 |

---

## 3. コマンド一覧

| コマンド | 機能 | 引数 | 委譲先 |
|---------|------|------|--------|
| `/draft-scene` | 下書き生成 | シーケンス, EP番号, 文字数 | draft-scene エージェント |
| `/count-chars` | 文字数カウント | 作品名, EP番号 | - |
| `/daily` | 日次振り返り | - | - |
| `/focus` | タスク集中 | 作品名 | - |
| `/generate-portrait` | キャラ画像プロンプト | キャラ名, スタイル | - |
| `/generate-scene-image` | シーン画像プロンプト | EP番号, シーン番号 | - |
| `/update-character-phase` | フェーズ切替 | キャラ名, フェーズ名 | - |
| `/update-world-phase` | フェーズ切替 | 設定名, フェーズ名 | - |
| `/adr-create` | ADR作成 | タイトル | - |

---

## 4. スキル一覧

| スキル | 適用タイミング | 内容 |
|-------|---------------|------|
| `plot-theories` | プロット作成/構成分析 | 三幕構成、起承転結、英雄の旅、Save the Cat |
| `character-theories` | キャラ設定抽出/アーク設計 | アーク類型、Want/Need、葛藤 |
| `style-guidelines` | 下書き生成/文体分析/推敲 | ラノベ文体、Web小説文体 |
| `quality-standards` | 品質レビュー | 評価基準、チェックリスト |
| `consistency-checker` | 整合性チェック | チェック項目、自動スクリプト |

**特徴**:
- `user-invocable: false` - ユーザーが直接呼び出すことはない
- エージェント実行時に自動適用
- 各スキルは `SKILL.md` (定義) + `reference.md` (詳細) で構成

---

## 5. 主要ワークフロー

### 5.1 下書き生成フロー

```
┌─────────────────────────────────────────────────────────────┐
│ /draft-scene {シーケンス} {EP番号}                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ draft-scene エージェント                                     │
│ Skills: plot-theories, character-theories, style-guidelines │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 1: コンテキスト収集 (AoT並列)                         │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Atom1: Plot L1 → テーマ、全体方向性                 │   │
│  │ Atom2: Plot L2 → 章の目的、状態変化目標             │   │
│  │ Atom3: Plot L3 → シーン構成、場面リスト             │   │
│  │ Atom4: Summary → これまでの流れ                     │   │
│  │ Atom5: Characters → current_phase の状態            │   │
│  │ Atom6: WorldSetting → current_phase の状態          │   │
│  │ Atom7: StyleGuide → 声、対話パターン                │   │
│  │ Atom8: StyleProfile → 平均文長、会話比率            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Step 2: フィルタリング                                     │
│  - `## 隠し設定` セクション → 除外                         │
│  - current_phase 以外 → 除外（回想シーン除く）             │
│                                                             │
│  Step 3: 整合性プレチェック                                 │
│  - 伏線チェック                                             │
│  - 状態整合チェック                                         │
│  - キャラ整合チェック                                       │
│  → 警告あれば表示、確認を求める                            │
│                                                             │
│  Step 4: 下書き生成                                         │
│  - テーマの一貫性維持                                       │
│  - 章の目的達成                                             │
│  - シーン目標達成                                           │
│  - 文体維持                                                 │
│  - 状態変化組み込み                                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 出力: 下書き Markdown                                        │
│ + 推奨アクション（サマリ更新、キャラ更新、伏線更新）        │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 整合性チェックフロー

```
┌─────────────────────────────────────────────────────────────┐
│ 「整合性をチェックして」                                     │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ check-consistency エージェント                               │
│ Skills: consistency-checker, quality-standards              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Step 1: 自動スクリプト実行                                 │
│  └─ scripts/check-consistency.py vault/{作品名}            │
│                                                             │
│  Step 2: 詳細チェック (AoT並列)                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Atom A: episodes    - エピソード網羅チェック        │   │
│  │ Atom B: parent      - 親子整合チェック              │   │
│  │ Atom C: foreshadow  - 伏線整合チェック              │   │
│  │ Atom D: character   - キャラ整合チェック            │   │
│  │ Atom E: world       - 世界観整合チェック            │   │
│  │                                                     │   │
│  │ ※ 全Atom完全独立、並列実行可能                      │   │
│  │ ※ 1Atomの失敗は他Atomに影響しない                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Step 3: 統合レポート生成                                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 出力: 整合性チェックレポート                                 │
│ - サマリ（✅/⚠️/❌）                                        │
│ - 詳細（各チェック項目）                                     │
│ - 推奨アクション（優先度別）                                 │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 プロット/サマリ作成フロー

```
[設計時: トップダウン]
  L1 Plot (全体)
    ↓ 詳細化
  L2 Plot (章)
    ↓ 詳細化
  L3 Plot (シーケンス)
    ↓ ガイド
  下書き生成

[執筆後: ボトムアップ]
  Episode (本文)
    ↓ 要約
  L3 Summary
    ↓ 統合
  L2 Summary
    ↓ 統合
  L1 Summary

[比較]
  Plot ←→ Summary
  → 乖離検出、軌道修正
```

### 5.4 3エージェントレビューフロー

```
┌─────────────────────────────────────────────────────────────┐
│ 「3視点で分析して」                                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ three-agents-review エージェント                             │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Phase 1: Divergence (発散)                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Affirmative Agent (肯定派)                          │   │
│  │ - メリット                                          │   │
│  │ - 実現可能性                                        │   │
│  │ - 期待される成果                                    │   │
│  └─────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Critical Agent (批判派)                             │   │
│  │ - リスク                                            │   │
│  │ - コスト                                            │   │
│  │ - 代替案                                            │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Phase 2: Debate (議論)                                     │
│  - 対立ポイントの解決策検討                                 │
│                                                             │
│  Phase 3: Convergence (収束)                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ Mediator Agent (仲介者)                             │   │
│  │ - 論点整理                                          │   │
│  │ - トレードオフ明確化                                │   │
│  │ - 軽減策提案                                        │   │
│  │ - 最終判断                                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│ 出力: 3エージェントレビューレポート                          │
│ + ADR連携オプション                                          │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. AoT (Atom of Thought) プロトコル

### 6.1 概要

複雑なタスクを独立した「Atom」に分解し、並列処理・エラー隔離を実現するフレームワーク。

### 6.2 Chain of Thought との比較

| 特徴 | Chain of Thought | Atom of Thought |
|-----|-----------------|-----------------|
| 構造 | 線形・順次的 | モジュール型・DAG |
| 依存関係 | 文脈履歴に強く依存 | マルコフ性（直前のみ） |
| エラー処理 | 後工程に伝播 | Atom内に隔離 |
| 焦点 | 物語的な流れ | 論理とインターフェース契約 |

### 6.3 ワークフロー

```
Phase 1: Decomposition (分解)
  - 独立したAtomに分解
  - 依存関係を明示的に特定
  - Atomリストを提示

Phase 2: Atomic Processing (処理)
  - 各Atomを独立・並列で処理
  - 実装詳細が他Atomへ漏れないようにする

Phase 3: Synthesis (統合)
  - Atomを組み合わせて解決策に
  - 統合チェック
  - ユーザー目的との照合
```

### 6.4 適用箇所

| エージェント | AoT適用 |
|-------------|---------|
| `draft-scene` | 8種のコンテキスト収集を並列Atom化 |
| `check-consistency` | 5種のチェック項目を並列Atom化 |
| `extract-character` | 5カテゴリの抽出を並列Atom化 |
| `extract-world` | カテゴリ別抽出項目を並列Atom化 |

---

## 7. 情報フィルタリング機構

### 7.1 隠し設定の除外

```
Character/WorldSetting ファイル
├─ ## 現在の状態      → 参照される
├─ ## フェーズ別記録  → 参照される
└─ ## 隠し設定        → 参照されない ⛔
```

**実装**: draft-scene エージェントの Step 2 で明示的に除外

### 7.2 フェーズフィルタリング

```yaml
phases:
  - name: "物語開始時"
    episodes: "1-10"
  - name: "覚醒後"      ← current_phase
    episodes: "11-"
current_phase: "覚醒後"
```

**ルール**:
- 通常: `current_phase` のみ参照
- 回想シーン: 過去フェーズを指定可能
- 整合性チェック: 全フェーズを参照

---

## 8. 機能マトリクス

### 8.1 エージェント × Skills

| エージェント | plot | character | style | quality | consistency |
|-------------|:----:|:---------:|:-----:|:-------:|:-----------:|
| draft-scene | ✅ | ✅ | ✅ | - | - |
| create-plot | ✅ | - | - | - | - |
| extract-summary | ✅ | - | - | - | - |
| extract-character | - | ✅ | - | - | - |
| analyze-style | - | - | ✅ | - | - |
| check-consistency | - | - | - | ✅ | ✅ |
| three-agents-review | - | - | - | ✅ | - |

### 8.2 エージェント × データ操作

| エージェント | Read | Write | 対象データ |
|-------------|:----:|:-----:|-----------|
| draft-scene | ✅ | ✅ | Plot, Summary, Character, World, Style |
| create-plot | ✅ | ✅ | Plot (L1/L2/L3) |
| extract-summary | ✅ | ✅ | Episode → Summary |
| extract-character | ✅ | ✅ | Episode → Character |
| check-consistency | ✅ | - | 全データ（読み取り専用） |
| three-agents-review | ✅ | - | 分析対象（読み取り専用） |

---

## 9. 新システムへの示唆

### 9.1 継承すべき設計パターン

| パターン | 説明 | 活用方法 |
|---------|------|---------|
| **Command-Agent分離** | UI(軽量) と 処理(重量) の分離 | そのまま採用 |
| **Skills自動適用** | エージェント実行時の知識ベース参照 | そのまま採用 |
| **AoT並列処理** | 独立タスクの並列化、エラー隔離 | 整合性チェックに適用 |
| **モード切替** | 全自動/複数案/ガイド付き | 柔軟な生成に活用 |
| **情報フィルタリング** | 隠し設定除外、フェーズ限定 | 伏線管理に拡張 |
| **3 Agents Model** | 多視点レビュー | 意思決定に活用 |

### 9.2 拡張が必要な領域

| 領域 | 現状 | 拡張案 |
|-----|------|-------|
| 伏線専用エージェント | なし | foreshadow-manager エージェント追加 |
| 伏線チェック | consistency内の一項目 | 独立した専用チェック機能 |
| 情報階層 | 2段階（通常/隠し） | 4段階（読者/書き手/AI/秘匿） |
| 伏線回収アラート | なし | 回収タイミングのリマインダー |

---

## 10. 参照

- `docs/Novel-Athanor-main/.claude/agents/`
- `docs/Novel-Athanor-main/.claude/commands/`
- `docs/Novel-Athanor-main/.claude/skills/`
- `docs/Novel-Athanor-main/.claude/protocols/atom-of-thought.md`
- `docs/specs/novel-generator/analysis-novel-athanor-architecture.md`
- `docs/specs/novel-generator/analysis-novel-athanor-datamodel.md`
