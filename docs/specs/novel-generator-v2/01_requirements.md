# 要件定義書

## 1. 機能要件

### 1.1 核心機能（Must Have）

#### FR-001: AI情報制御システム

| 項目 | 内容 |
|------|------|
| 概要 | AIが設定情報をどの程度認識・使用できるかを制御する |
| 優先度 | 最高 |
| 根拠 | ユーザー要望「AIがネタバレを文章に混ぜてしまうことを一番恐れている」 |

**4段階可視性レベル**:

| Level | 名称 | AIの認識 | AIの行動 | プロンプト例 |
|-------|------|---------|---------|-------------|
| 0 | 完全秘匿 | 存在すら知らない | 何も書けない | （コンテキストに含めない） |
| 1 | 認識のみ | 「何かある」と知る | 内容には触れない | `"There is a hidden secret about X, but do NOT reveal it."` |
| 2 | 内容認識 | 内容を知っている | 文章には出さない | `"Secret is Y. Create tension/hints, but NEVER state Y."` |
| 3 | 使用可能 | 完全に把握 | 文章で使ってよい | （通常コンテキスト） |

#### FR-002: 伏線管理システム（Chekhov's Gun Tracker）

| 項目 | 内容 |
|------|------|
| 概要 | 伏線の登録・追跡・回収を管理する |
| 優先度 | 高 |
| 根拠 | 3システムすべてに欠如している機能 |

**伏線ライフサイクル**:
```
registered → planted → reinforced → revealed
（登録）    （設置）   （強化）     （回収）
```

**微細度スケール（subtlety_level）**:
- 1（明白）: 読者が即座に気づく
- 5（標準）: 注意深い読者が気づく
- 10（極微細）: 回収時に初めて認識される

#### FR-003: 階層構造管理（L1/L2/L3）

| 項目 | 内容 |
|------|------|
| 概要 | プロット/サマリを3階層で管理 |
| 優先度 | 高 |
| 採用元 | Novel-Athanor |

| 階層 | 対象 | 用途 |
|------|------|------|
| L1 | 作品全体 | 全体方針、テーマ |
| L2 | 章 | 章の目的、状態変化 |
| L3 | シーケンス | 場面構成、具体的イベント |

#### FR-004: フェーズ管理

| 項目 | 内容 |
|------|------|
| 概要 | キャラクター/世界観の時系列状態を管理 |
| 優先度 | 高 |
| 採用元 | Novel-Athanor |

---

### 1.2 品質管理機能（Should Have）

#### FR-005: 自動品質スコアリング

| 項目 | 内容 |
|------|------|
| 概要 | 生成コンテンツの品質を自動評価 |
| 優先度 | 中 |
| 採用元 | NovelWriter |

**評価指標**:
| 指標 | 説明 | 閾値 |
|------|------|------|
| coherence_score | シーン間の一貫性 | ≥ 0.6 |
| pacing_score | ペーシングの適切さ | ≥ 0.6 |
| prose_score | 文章品質 | ≥ 0.65 |
| character_score | キャラクター描写 | ≥ 0.6 |
| style_consistency | 文体一貫性 | ≥ 0.65 |
| reader_excitement | 読者の興奮・期待感 | ≥ 0.6 |
| emotional_resonance | 感情的共鳴 | ≥ 0.6 |

#### FR-006: 整合性チェック

| 項目 | 内容 |
|------|------|
| 概要 | キャラクター/世界観/伏線の矛盾を検出 |
| 優先度 | 中 |
| 採用元 | NovelWriter + Novel-Athanor |

#### FR-007: Reviewer Agent による情報漏洩チェック

| 項目 | 内容 |
|------|------|
| 概要 | 生成文にLevel 0-2の秘密が漏洩していないかチェック |
| 優先度 | 中 |
| 採用元 | Antigravity |

---

### 1.3 執筆支援機能（Should Have）

#### FR-008: 下書き生成

| 項目 | 内容 |
|------|------|
| 概要 | コンテキストに基づいて下書きを生成 |
| 優先度 | 高 |
| 採用元 | Novel-Athanor |

#### FR-009: 設定抽出

| 項目 | 内容 |
|------|------|
| 概要 | 執筆済みエピソードからキャラクター/世界観/サマリを抽出 |
| 優先度 | 中 |
| 採用元 | Novel-Athanor |

#### FR-010: スタイルテンプレート

| 項目 | 内容 |
|------|------|
| 概要 | サンプルベースの文体指定 |
| 優先度 | 低 |
| 採用元 | 302_novel_writing |

---

## 2. 非機能要件

### 2.1 パフォーマンス

| 要件ID | 要件 | 目標値 | 対応策 |
|--------|------|--------|--------|
| NFR-001 | 大規模作品対応 | 100話以上 | Lazy Loading Context |
| NFR-002 | コンテキスト最適化 | 8K-15Kトークン/操作 | 動的フィルタリング |
| NFR-003 | 応答時間 | < 60秒（下書き生成） | AoT並列処理 |

### 2.2 拡張性

| 要件ID | 要件 | 対応策 |
|--------|------|--------|
| NFR-004 | 新ジャンル/スタイル追加 | テンプレートベース設計 |
| NFR-005 | 新エージェント追加 | モジュラーエージェント設計 |
| NFR-006 | 新可視性レベル追加 | プラグイン構造 |

### 2.3 保守性

| 要件ID | 要件 | 対応策 |
|--------|------|--------|
| NFR-007 | 人間可読データ | Markdown + YAML維持 |
| NFR-008 | 設定編集容易性 | Obsidian統合 |
| NFR-009 | デバッグ容易性 | 詳細ログ出力 |

### 2.4 互換性

| 要件ID | 要件 | 対応策 |
|--------|------|--------|
| NFR-010 | Obsidian連携 | `[[リンク]]`記法、vault構造 |
| NFR-011 | Novel-Athanor互換 | マイグレーションパス提供 |
| NFR-012 | Git連携 | Diff可読性維持 |

---

## 3. ユースケース

### UC-001: 新作開始

```
アクター: 作家
前提条件: なし
基本フロー:
  1. 作品ディレクトリを作成
  2. L1プロットを作成
  3. キャラクター設定を作成
  4. 世界観設定を作成
  5. 伏線を登録（ai_visibility設定）
  6. L2/L3プロットを作成
  7. 第1話の下書きを生成
成功条件: 第1話の下書きが生成される
```

### UC-002: 連載継続

```
アクター: 作家
前提条件: 既存作品が存在
基本フロー:
  1. 現在のフェーズを確認
  2. L3プロットを確認/更新
  3. 伏線状態を確認（張るべき/回収すべき）
  4. 下書きを生成
  5. 品質スコアを確認
  6. Reviewerチェックを実行
  7. 必要に応じて修正
  8. サマリを更新
成功条件: 新エピソードが完成
```

### UC-003: 伏線管理

```
アクター: 作家
前提条件: 作品が存在
基本フロー:
  1. 伏線を登録（status: registered）
  2. ai_visibility を設定（Level 0-2）
  3. 伏線を張る（status: planted）
  4. 必要に応じて強化（status: reinforced）
  5. 回収時に ai_visibility を Level 3 に変更
  6. 伏線を回収（status: revealed）
成功条件: 伏線が適切に管理される
```

### UC-004: 推敲・修正

```
アクター: 作家
前提条件: 下書きが存在
基本フロー:
  1. 品質スコアを確認
  2. 低スコア項目を特定
  3. 改善提案を取得
  4. 手動修正 or リライト依頼
  5. 再度品質チェック
成功条件: 品質スコアが閾値を超える
```

### UC-005: フェーズ更新

```
アクター: 作家
前提条件: 作品が存在、状態変化イベント発生
基本フロー:
  1. 新フェーズを定義
  2. 影響範囲を確認（影響分析）
  3. キャラクター設定を更新
  4. 世界観設定を更新
  5. current_phase を切り替え
成功条件: フェーズが正しく更新される
```

### UC-006: 振り返り

```
アクター: 作家
前提条件: 複数エピソードが存在
基本フロー:
  1. Plot L1 と Summary L1 を比較
  2. 乖離ポイントを特定
  3. 計画修正 or 継続を判断
  4. 伏線回収状況を確認
  5. 次のマイルストーンを設定
成功条件: 計画と実績の差異が明確になる
```

### UC-007: 複数作品並行執筆

```
アクター: 作家
前提条件: 複数作品が存在
基本フロー:
  1. /athanor switch {作品名} で作品切替
  2. 作品固有のコンテキストがロードされる
  3. 伏線/フェーズ状態が作品ごとに独立
  4. 共有設定（vault/shared/）は全作品で共通
成功条件: 作品間の設定が混在しない
```

---

## 4. MVP スコープと実装優先順位

### 4.1 MVP（Minimum Viable Product）定義

Phase 1 で実装する最小機能セット:

| 優先度 | 機能 | 理由 |
|--------|------|------|
| **P0** | 執筆・保存 | 基本機能、これがないと何も始まらない |
| **P0** | 伏線メモ | 簡易的な伏線登録（フルトラッカーは後回し） |
| **P0** | データモデル | データの置き場が決まらないと何も始まらない |
| **P1** | Chekhov's Gun Tracker | 単体でも価値があるツール |
| **P1** | AI情報制御（Level 0/3） | 最もシンプルな実装（含める/除外） |
| **P2** | AI情報制御（Level 1/2） | 高度機能として後回し |
| **P2** | 品質スコアリング | 最初は人間がレビュワーになれば良い |

### 4.2 段階的リリース計画

```
Phase 1 (MVP):
  - 執筆・保存・伏線メモ
  - Level 0/3 のAI制御
  - 基本的なThe Relayフロー

Phase 2:
  - Level 1/2 のAI制御
  - Chekhov's Gun Tracker完全版
  - 基本的な品質チェック

Phase 3:
  - 高度な品質スコアリング
  - 意図しない伏線検出
  - ダッシュボード・可視化
```

### 4.3 複数作品サポート

Must要件として実装する。作家は同時に短編を書きながら長編を進めることがある。

```
vault/
├── 作品A/
│   ├── episodes/
│   ├── characters/
│   ├── _foreshadowing/
│   └── _ai_control/
├── 作品B/
│   └── ...
└── shared/           # 共有設定
    └── magic_system.md
```

---

## 5. 制約事項

| 制約 | 理由 | 影響 |
|------|------|------|
| Claude Code依存 | 開発リソース最適化 | 他LLM非対応（コアロジックはLLM非依存に設計し、将来のLocal LLM移行を容易にする） |
| Claude APIのみ | スタートアップとして正しい選択、最適化に集中 | 他API非対応 |
| 日本語優先 | ターゲットユーザー | 多言語対応は将来課題 |
| CLI中心 | Obsidian統合 | WebUI非対応 |
