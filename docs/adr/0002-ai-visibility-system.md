# ADR-0002: 4段階AI可視性システム

## メタ情報
| 項目 | 内容 |
|------|------|
| ステータス | Accepted |
| 日付 | 2026-01-24 |
| 意思決定者 | プロジェクトオーナー |
| 関連ADR | [ADR-0001](./0001-three-project-integration.md) |

## コンテキスト

### 背景
AI による小説執筆支援において、「ネタバレ防止」は重要な課題である。AIが物語の結末や伏線の回収を事前に知っていると、執筆中にそれを意図せず漏らしてしまう可能性がある。

従来のシステムでは、AIに全情報を与えるか与えないかの二択しかなく、細やかな情報制御ができなかった。

### 制約条件
- AI（Claude）のコンテキストに渡す情報を制御する必要
- ユーザーは「書き手視点」と「読者視点」の両方を使い分けたい
- 伏線は「存在の認識」と「内容の認識」を分離したい

### 要求事項
- AIへの情報開示レベルを段階的に制御
- 伏線管理システムとの連携
- 執筆フェーズに応じた自動切り替え

## 検討した選択肢

### Option A: 2段階（公開/非公開）
**概要**: 情報を「見せる」「見せない」の二択で制御

**メリット**:
- 実装がシンプル
- 理解しやすい

**デメリット**:
- 「匂わせ」ができない
- 伏線の繊細な扱いが困難

### Option B: 3段階（公開/認識のみ/非公開）
**概要**: 「内容は隠すが存在は知らせる」レベルを追加

**メリット**:
- 伏線の「匂わせ」が可能
- 2段階より柔軟

**デメリット**:
- 「書く」vs「書かない」の区別がない

### Option C: 4段階（完全秘匿/認識のみ/内容認識/使用可能）
**概要**: 情報の認識レベルと使用可否を分離した4段階制御

| Level | 名称 | AI の認識 | AI の行動 |
|-------|------|----------|----------|
| 0 | 完全秘匿 | 存在すら知らない | 言及不可 |
| 1 | 認識のみ | 「何かある」と知る | 匂わせのみ |
| 2 | 内容認識 | 内容を知っている | 直接言及禁止 |
| 3 | 使用可能 | 完全に把握 | 自由に使用 |

**メリット**:
- 最も細やかな制御が可能
- 伏線の段階的開示に最適
- 「知っているけど書かない」が表現可能

**デメリット**:
- 実装複雑度が高い
- ユーザーが理解しにくい可能性

## 3 Agents Analysis

### [Affirmative] 推進者の視点
> 最高の結果はどうなるか？どうすれば実現できるか？

- 4段階あれば、伏線の繊細な扱いが可能になる
- 「匂わせ」から「回収」までの段階的制御で、読者体験を損なわない
- Level 2（内容認識・言及禁止）は他システムにない差別化ポイント
- プロンプトエンジニアリングで十分実現可能

### [Critical] 批判者の視点
> 最悪の場合どうなるか？何が壊れるか？

- 4段階は複雑すぎてユーザーが混乱する
- AIが指示を守れない（Level 2で漏らしてしまう）リスク
- 管理コストの増大
- 実装・テストの難易度上昇

### [Mediator] 調停者の視点
> 今、我々が取るべき最善のバランスは何か？

- 4段階システムを採用するが、デフォルトは Level 3（使用可能）
- 通常の執筆では複雑さを感じさせない
- 伏線登録時にのみ Level 選択を促す
- AI への指示は明確なシステムプロンプトで制御

## 決定

**採用**: Option C（4段階可視性システム）

### 決定理由
- 「半自動小説生成」の差別化ポイントとして不可欠
- 伏線管理システム（ADR-0003）との相乗効果
- 段階的な情報開示により、意図した物語体験を設計可能

### 却下理由
- **Option A**: ネタバレ防止には不十分
- **Option B**: 「書く/書かない」の制御ができない

## 影響

### ポジティブな影響
- 他システムにない独自機能として差別化
- 伏線管理と組み合わせた高度な物語設計が可能
- ユーザーが「読者視点」で執筆できる

### ネガティブな影響
- 実装複雑度の増加（緩和策: コア機能を先に実装、段階的に拡張）
- ユーザー教育が必要（緩和策: デフォルトはシンプルに、高度機能はオプション）

### 影響を受けるコンポーネント
- `docs/specs/novel-generator-v2/04_ai-information-control.md`: 仕様定義済み
- `src/core/visibility/`: 実装予定
- 全エージェント: 可視性レベルを考慮した動作が必要

## 実装計画

### フェーズ1: コア実装
- [ ] VisibilityLevel 列挙型定義
- [ ] 情報フィルタリング機構
- [ ] プロンプト生成時のレベル適用

### フェーズ2: 伏線連携
- [ ] Chekhov's Gun Tracker との統合
- [ ] 自動レベル昇格機能

### フェーズ3: UI/UX
- [ ] 可視性設定インターフェース
- [ ] 執筆時のレベル表示

## 検証方法
- Level 2 設定時に AI が直接言及しないことを確認
- Level 1 設定時に「匂わせ」が適切に行われることを確認
- ユーザーテストで混乱なく使用できることを確認

## 参考資料
- `docs/specs/novel-generator-v2/04_ai-information-control.md`: 詳細仕様
- `docs/memo/最初の思いつき.md`: 構想の原点
