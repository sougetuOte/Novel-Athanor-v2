# 実装タスクバックログ

**作成日**: 2026-01-24
**ステータス**: PLANNING
**対象仕様**: `docs/specs/novel-generator-v2/` (00-09)

---

## 概要

Novel-Athanor-v2 の実装タスクを、仕様書に基づいて細分化したバックログ。
各タスクは **1 PR 以内** で完結するサイズに分割されている。

### 優先度定義

| 優先度 | 説明 |
|--------|------|
| P0 | 必須基盤（他タスクの前提） |
| P1 | コア機能 |
| P2 | 拡張機能 |
| P3 | 最適化・改善 |

### ステータス定義

| ステータス | 説明 |
|-----------|------|
| 🔲 backlog | 未着手 |
| 📋 ready | 着手可能（前提タスク完了） |
| 🔨 in_progress | 作業中 |
| ✅ done | 完了 |
| ⏸️ blocked | ブロック中 |

---

## Layer 0: プロジェクト基盤

### L0-1: 開発環境セットアップ

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L0-1-1 | Python プロジェクト初期化（pyproject.toml） | P0 | - | ✅ |
| L0-1-2 | ディレクトリ構造作成（src/core, src/agents, src/cli） | P0 | L0-1-1 | ✅ |
| L0-1-3 | pytest 環境セットアップ | P0 | L0-1-1 | ✅ |
| L0-1-4 | 型チェック設定（mypy/pyright） | P0 | L0-1-1 | ✅ |
| L0-1-5 | リンター設定（ruff） | P0 | L0-1-1 | ✅ |

---

## Layer 1: データレイヤー

### L1-1: YAML/Markdown パーサー

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L1-1-1 | YAML frontmatter パーサー実装 | P0 | L0-1-2 | ✅ |
| L1-1-2 | Markdown 本文抽出機能 | P0 | L0-1-2 | ✅ |
| L1-1-3 | パースエラー時のフォールバック実装 | P1 | L1-1-1 | ✅ |
| L1-1-4 | パーサーユニットテスト | P0 | L1-1-1, L1-1-2 | ✅ |

### L1-2: データモデル定義

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L1-2-1 | Episode モデル（Pydantic） | P0 | L0-1-2 | ✅ |
| L1-2-2 | Character モデル（フェーズ対応） | P0 | L0-1-2 | ✅ |
| L1-2-3 | WorldSetting モデル（フェーズ対応） | P0 | L0-1-2 | ✅ |
| L1-2-4 | Plot L1/L2/L3 モデル | P0 | L0-1-2 | ✅ |
| L1-2-5 | Summary L1/L2/L3 モデル | P0 | L0-1-2 | ✅ |
| L1-2-6 | Foreshadowing モデル | P1 | L0-1-2 | ✅ |
| L1-2-7 | AIVisibility モデル | P1 | L0-1-2 | ✅ |
| L1-2-8 | Secret モデル | P1 | L0-1-2 | ✅ |
| L1-2-9 | StyleGuide / StyleProfile モデル | P2 | L0-1-2 | ✅ |
| L1-2-10 | モデルバリデーションテスト | P0 | L1-2-1〜L1-2-8 | ✅ |

### L1-3: Vault 構造管理

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L1-3-1 | Vault 初期化スクリプト | P1 | L1-2-1 | ✅ |
| L1-3-2 | ファイルパス解決ユーティリティ | P0 | L0-1-2 | ✅ |
| L1-3-3 | Obsidian リンク（[[]]）パーサー | P1 | L1-1-2 | ✅ |
| L1-3-4 | 大規模作品対応（Volume 分割） | P3 | L1-3-2 | 🔲 |

### L1-4: データ永続化

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L1-4-1 | エンティティ CRUD 基底クラス | P0 | L1-2-1, L1-1-1 | ✅ |
| L1-4-2 | Episode リポジトリ | P0 | L1-4-1 | ✅ |
| L1-4-3 | Character リポジトリ | P0 | L1-4-1 | ✅ |
| L1-4-4 | Foreshadowing リポジトリ | P1 | L1-4-1, L1-2-6 | ✅ |
| L1-4-5 | リポジトリ統合テスト | P0 | L1-4-2, L1-4-3 | ✅ |

---

## Layer 2: AI情報制御レイヤー

### L2-1: Visibility Controller

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L2-1-1 | VisibilityLevel 列挙型定義（0-3） | P1 | L0-1-2 | 🔲 |
| L2-1-2 | セクション単位可視性判定ロジック | P1 | L2-1-1, L1-2-7 | 🔲 |
| L2-1-3 | HTMLコメント `<!-- ai_visibility: N -->` パーサー | P1 | L1-1-2 | 🔲 |
| L2-1-4 | 可視性フィルタリング関数 | P1 | L2-1-2, L2-1-3 | 🔲 |
| L2-1-5 | 可視性フィルタリングテスト | P1 | L2-1-4 | 🔲 |

### L2-2: Expression Filter

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L2-2-1 | 禁止キーワードマッチャー | P1 | L1-2-8 | 🔲 |
| L2-2-2 | 類似度チェック（設定文との比較） | P2 | L2-2-1 | 🔲 |
| L2-2-3 | 許可表現リスト管理 | P2 | L2-2-1 | 🔲 |
| L2-2-4 | Expression Filter 統合テスト | P1 | L2-2-1 | 🔲 |

### L2-3: Foreshadowing Manager

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L2-3-1 | 伏線状態遷移ロジック（planted→growing→ready→harvested） | P1 | L1-2-6 | 🔲 |
| L2-3-2 | Subtlety レベル（1-10）管理 | P1 | L2-3-1 | 🔲 |
| L2-3-3 | 伏線→可視性レベル自動マッピング | P1 | L2-3-1, L2-1-1 | 🔲 |
| L2-3-4 | 伏線タイムライン追跡 | P2 | L2-3-1, L1-4-4 | 🔲 |
| L2-3-5 | 回収期限アラート機能 | P2 | L2-3-4 | 🔲 |
| L2-3-6 | Foreshadowing Manager テスト | P1 | L2-3-1, L2-3-2, L2-3-3 | 🔲 |

---

## Layer 3: コンテキスト構築レイヤー

### L3-1: Context Builder

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L3-1-1 | シーン→関連ファイル特定ロジック | P1 | L1-3-2, L1-3-3 | 🔲 |
| L3-1-2 | Lazy Loader 実装 | P1 | L3-1-1 | 🔲 |
| L3-1-3 | Phase Filter（current_phase フィルタ） | P1 | L1-2-2, L1-2-3 | 🔲 |
| L3-1-4 | AoT Parallel Collector（並列読み込み） | P2 | L3-1-2 | 🔲 |
| L3-1-5 | Context Builder 統合テスト | P1 | L3-1-2, L3-1-3 | 🔲 |

### L3-2: コンテキスト統合

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L3-2-1 | フィルタ済みコンテキスト構造体 | P1 | L3-1-2, L2-1-4 | 🔲 |
| L3-2-2 | 伏線指示書生成 | P1 | L2-3-3, L3-2-1 | 🔲 |
| L3-2-3 | 禁止キーワードリスト統合 | P1 | L2-2-1, L3-2-1 | 🔲 |
| L3-2-4 | コンテキスト統合テスト | P1 | L3-2-1, L3-2-2, L3-2-3 | 🔲 |

---

## Layer 4: エージェントレイヤー

### L4-1: エージェント基盤

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L4-1-1 | Agent 基底クラス定義 | P1 | L0-1-2 | 🔲 |
| L4-1-2 | エージェント設定ローダー（.claude/agents/*.md） | P1 | L1-1-1, L1-1-2 | 🔲 |
| L4-1-3 | パイプライン実行フレームワーク | P1 | L4-1-1 | 🔲 |
| L4-1-4 | エージェント間ログ記録（JSONL） | P2 | L4-1-3 | 🔲 |

### L4-2: Continuity Director

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L4-2-1 | Continuity Director エージェント定義（.claude/agents/） | P1 | L4-1-1 | 🔲 |
| L4-2-2 | get_filtered_context ツール実装 | P1 | L3-2-1, L4-2-1 | 🔲 |
| L4-2-3 | 伏線指示書作成ロジック | P1 | L3-2-2, L4-2-1 | 🔲 |
| L4-2-4 | Continuity Director テスト | P1 | L4-2-2, L4-2-3 | 🔲 |

### L4-3: Ghost Writer

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L4-3-1 | Ghost Writer エージェント定義 | P1 | L4-1-1 | 🔲 |
| L4-3-2 | 執筆プロンプトテンプレート | P1 | L4-3-1 | 🔲 |
| L4-3-3 | スタイルガイド適用ロジック | P2 | L4-3-2, L1-2-9 | 🔲 |
| L4-3-4 | Ghost Writer テスト（モック） | P1 | L4-3-1, L4-3-2 | 🔲 |

### L4-4: Reviewer

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L4-4-1 | Reviewer エージェント定義 | P1 | L4-1-1 | 🔲 |
| L4-4-2 | review_draft ツール実装 | P1 | L2-2-1, L4-4-1 | 🔲 |
| L4-4-3 | Human Fallback ロジック（3回リトライ制限） | P1 | L4-4-2 | 🔲 |
| L4-4-4 | Reviewer テスト | P1 | L4-4-2, L4-4-3 | 🔲 |

### L4-5: Quality Agent

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L4-5-1 | Quality Agent エージェント定義 | P1 | L4-1-1 | 🔲 |
| L4-5-2 | 品質スコアリングロジック | P1 | L4-5-1 | 🔲 |
| L4-5-3 | 品質閾値設定読み込み | P1 | L4-5-2 | 🔲 |
| L4-5-4 | Quality Agent テスト | P1 | L4-5-2, L4-5-3 | 🔲 |

### L4-6: 補助エージェント

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L4-6-1 | Consistency Agent 定義 | P2 | L4-1-1 | 🔲 |
| L4-6-2 | Foreshadowing Agent 定義 | P2 | L4-1-1, L2-3-1 | 🔲 |
| L4-6-3 | Extract Agent 定義 | P2 | L4-1-1 | 🔲 |
| L4-6-4 | Style Agent 定義 | P3 | L4-1-1 | 🔲 |

---

## Layer 5: 統制レイヤー

### L5-1: The Relay ワークフロー

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L5-1-1 | The Relay プロトコル定義（.claude/protocols/） | P1 | L4-2-1, L4-3-1, L4-4-1, L4-5-1 | 🔲 |
| L5-1-2 | パイプライン実行オーケストレーター | P1 | L4-1-3, L5-1-1 | 🔲 |
| L5-1-3 | フィードバックループ実装 | P1 | L5-1-2 | 🔲 |
| L5-1-4 | ループ回数制限（最大3回） | P1 | L5-1-3 | 🔲 |
| L5-1-5 | The Relay 統合テスト | P1 | L5-1-2, L5-1-3, L5-1-4 | 🔲 |

### L5-2: Phase-Gate-Approval

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L5-2-1 | フェーズ状態管理（.claude/states/） | P1 | L0-1-2 | 🔲 |
| L5-2-2 | 承認ゲートロジック | P1 | L5-2-1 | 🔲 |
| L5-2-3 | フェーズ遷移コマンド（/next-phase） | P2 | L5-2-2 | 🔲 |

### L5-3: CLI コマンド

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L5-3-1 | /draft-scene コマンド | P1 | L5-1-2 | 🔲 |
| L5-3-2 | /register-foreshadowing コマンド | P1 | L2-3-1 | 🔲 |
| L5-3-3 | /check-foreshadowing コマンド | P2 | L2-3-4 | 🔲 |
| L5-3-4 | /init-vault コマンド | P1 | L1-3-1 | 🔲 |
| L5-3-5 | /quality-report コマンド | P2 | L4-5-2 | 🔲 |

---

## Layer 6: 品質・運用

### L6-1: テスト拡充

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L6-1-1 | E2E テストシナリオ作成 | P2 | L5-1-5 | 🔲 |
| L6-1-2 | パフォーマンステスト（1000ファイル） | P3 | L1-4-5 | 🔲 |
| L6-1-3 | 循環参照テスト | P2 | L1-3-3 | 🔲 |

### L6-2: ドキュメント

| ID | タスク | 優先度 | 依存 | ステータス |
|----|--------|--------|------|-----------|
| L6-2-1 | ユーザーマニュアル作成 | P2 | L5-3-1 | 🔲 |
| L6-2-2 | API リファレンス | P2 | L4-2-2, L4-4-2 | 🔲 |
| L6-2-3 | チュートリアル（Getting Started） | P2 | L6-2-1 | 🔲 |

---

## 実装順序（推奨）

### Phase 1: 基盤構築（MVP準備）

```
L0-1-1 → L0-1-2 → L0-1-3/L0-1-4/L0-1-5（並列）
        ↓
L1-1-1/L1-1-2 → L1-1-4 → L1-2-1〜L1-2-8 → L1-2-10
        ↓
L1-3-2 → L1-4-1 → L1-4-2/L1-4-3 → L1-4-5
```

### Phase 2: AI情報制御

```
L2-1-1 → L2-1-2/L2-1-3 → L2-1-4 → L2-1-5
        ↓
L2-2-1 → L2-2-4
        ↓
L2-3-1 → L2-3-2/L2-3-3 → L2-3-6
```

### Phase 3: エージェント実装

```
L3-1-1 → L3-1-2/L3-1-3 → L3-2-1 → L3-2-2/L3-2-3 → L3-2-4
        ↓
L4-1-1 → L4-1-2/L4-1-3
        ↓
L4-2-1 → L4-2-2/L4-2-3 → L4-2-4
        ↓
L4-3-1 → L4-3-2 → L4-3-4
        ↓
L4-4-1 → L4-4-2 → L4-4-3 → L4-4-4
        ↓
L4-5-1 → L4-5-2/L4-5-3 → L4-5-4
```

### Phase 4: 統合

```
L5-1-1 → L5-1-2 → L5-1-3/L5-1-4 → L5-1-5
        ↓
L5-3-1/L5-3-2/L5-3-4
```

---

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-24 | 初版作成 |
| 2026-01-25 | L1 レイヤー全タスク完了（L1-2-6〜L1-4-4） |
