# ADR-0006: The Relay ワークフロー

## メタ情報
| 項目 | 内容 |
|------|------|
| ステータス | Accepted |
| 日付 | 2026-01-24 |
| 意思決定者 | プロジェクトオーナー |
| 関連ADR | [ADR-0005](./0005-semi-automation-approach.md) |

## コンテキスト

### 背景
半自動化アプローチ（ADR-0005）を具体化するワークフローが必要。複数のAIエージェントが協調して小説を生成する際、どのような連携パターンを採用するかを決定する。

NovelWriter のマルチエージェント設計を参考に、本プロジェクト独自のワークフローを設計する。

### 制約条件
- エージェント間でコンテキスト（物語設定、伏線状態など）を共有
- 各エージェントの責務を明確に分離
- 人間の承認ポイントを組み込む

### 要求事項
- エージェント間の依存関係を明確化
- 失敗時のリカバリー戦略
- 品質チェックの自動化

## 検討した選択肢

### Option A: パイプライン型
**概要**: 直列にエージェントを接続

```
Planner → Writer → Editor → Output
```

**メリット**:
- シンプル
- 依存関係が明確

**デメリット**:
- 並列処理ができない
- 一箇所の失敗で全体が止まる

### Option B: ハブ型
**概要**: 中央コーディネーターが全エージェントを制御

```
     ┌── Planner
     │
Hub ─┼── Writer
     │
     └── Editor
```

**メリット**:
- 柔軟な制御
- 状態の一元管理

**デメリット**:
- Hub がボトルネック
- Hub の複雑化

### Option C: The Relay（リレー型）
**概要**: バトンを渡すように、エージェントが順次処理し、品質チェックを挟む

```
Continuity Director → Ghost Writer → Reviewer → Quality Agent
      ↑                                              │
      └──────────────── Feedback Loop ───────────────┘
```

**メリット**:
- 各エージェントの責務が明確
- フィードバックループで品質向上
- 承認ゲートを自然に組み込める

**デメリット**:
- ループ時のコンテキスト管理
- 無限ループ防止が必要

### Option D: イベント駆動型
**概要**: イベントバスで疎結合に連携

**メリット**:
- 最も柔軟
- 新エージェント追加が容易

**デメリット**:
- デバッグが困難
- 全体フローの把握が難しい

## 3 Agents Analysis

### [Affirmative] 推進者の視点
> 最高の結果はどうなるか？どうすれば実現できるか？

- The Relay は「リレー競走」のメタファーで直感的
- バトン（コンテキスト）が明確に定義される
- フィードバックループで自己改善
- 承認ゲートを Reviewer と Quality Agent の間に置ける
- 各エージェントの責務が明確で、テスト・デバッグしやすい

### [Critical] 批判者の視点
> 最悪の場合どうなるか？何が壊れるか？

- フィードバックループが無限ループになるリスク
- コンテキストが肥大化してトークン制限に達する
- 複数章の並列処理ができない
- エージェント間のインターフェース変更が波及

### [Mediator] 調停者の視点
> 今、我々が取るべき最善のバランスは何か？

- Option C（The Relay）を採用
- ループ回数に上限を設定（最大3回など）
- コンテキスト圧縮戦略を別途検討
- 将来的に章単位の並列処理を追加できる設計に

## 決定

**採用**: Option C（The Relay ワークフロー）

### 決定理由
- 半自動化（ADR-0005）との親和性が高い
- エージェントの責務が明確
- 品質チェックが自然に組み込める
- 「リレー」のメタファーがわかりやすい

### 却下理由
- **Option A**: 品質フィードバックが困難
- **Option B**: Hub が複雑化する
- **Option D**: デバッグ・理解が困難

## 影響

### ポジティブな影響
- 明確なワークフローで開発・デバッグが容易
- 品質向上のためのフィードバックループ
- 各エージェントの独立テストが可能

### ネガティブな影響
- ループ管理の実装が必要（緩和策: 回数上限 + 品質閾値）
- 直列処理なので並列化が制限（緩和策: 章単位並列は将来対応）

### 影響を受けるコンポーネント
- `docs/specs/novel-generator-v2/07_workflow.md`: 仕様定義済み
- `docs/specs/novel-generator-v2/08_agent-design.md`: エージェント設計
- `src/workflow/`: ワークフローエンジン実装予定

## The Relay エージェント

| エージェント | 責務 |
|-------------|------|
| **Continuity Director** | 設定・伏線の整合性維持、コンテキスト準備 |
| **Ghost Writer** | 実際の文章生成 |
| **Reviewer** | 文体・読みやすさのレビュー |
| **Quality Agent** | 最終品質チェック、フィードバック判定 |

## 実装計画

### フェーズ1: 基本フロー
- [ ] ワークフローエンジン
- [ ] バトン（コンテキスト）データ構造
- [ ] 基本的な直列処理

### フェーズ2: フィードバックループ
- [ ] 品質スコア算出
- [ ] ループ判定ロジック
- [ ] ループ回数制限

### フェーズ3: 最適化
- [ ] コンテキスト圧縮
- [ ] 章単位並列処理
- [ ] キャッシュ戦略

## 検証方法
- 各エージェントの入出力テスト
- フィードバックループの収束確認
- 生成品質の定量評価

## 参考資料
- `docs/specs/novel-generator-v2/07_workflow.md`: ワークフロー仕様
- `docs/specs/novel-generator-v2/08_agent-design.md`: エージェント設計
- NovelWriter: マルチエージェント設計の参考
