# レビュー回答

## Meta

| 項目 | 値 |
|------|-----|
| Session ID | 2026-01-25_002 |
| 日時 | 2026-01-25 |
| レビュアー | Antigravity |
| 判定 | **A (Approve)** |

## 1. L2 単体品質

L2 レイヤーの各コンポーネントは機能要件（仕様書 Section 2-7）を適切に満たしています。

*   **Security (WARN-002)**: `src/core/parsers/visibility_comment.py` にて、不正な `ai_visibility` レベル（0-3以外、数値以外）が検出された際に `ValueError` を送出する実装を確認しました。これにより、意図しないデフォルト値（Level 3あるいは0）が適用されることによる情報漏洩リスク（あるいは過剰な秘匿による執筆阻害）が排除されています。「Fail Fast」の原則に従った適切な設計です。
*   **Test Coverage**: 提供されたテストファイル（`tests/core/` 以下）は、正常系だけでなく、空白処理、ネストされたセクション、無効な入力などの異常系も網羅しており、十分なカバレッジがあります。特に `test_foreshadowing_manager.py` における状態遷移の網羅性は高く評価できます。

## 2. L0/L1 との整合性

L0/L1 レイヤー（データモデル）と L2 レイヤー（サービス/ロジック）の責任分界点は明確であり、依存関係も L2 → L1 の一方向で健全です。

*   **AIVisibilityLevel**: `models` (L1) で定義された Enum が `services` (L2) で一貫して使用されています。
*   **Foreshadowing**: モデル（状態）とマネージャ（遷移ロジック）の分離ができています。`ForeshadowingAIVisibility` の更新ロジックにおいて、既存の `forbidden_keywords` 等を保持しつつ `level` のみを動的に計算する実装は、データの永続性を考慮した良い設計です。
*   **Parsers**: L1 の `obsidian_link.py` と同様、正規表現による堅牢なパース処理が実装されており、設計の一貫性が保たれています。

## 3. 確認事項への回答

レビュー依頼で挙げられた「特に確認してほしい点」への回答です。

1.  **セキュリティ設計**:
    *   **判定: 適切 (Approved)**
    *   前述の通り、例外による即時停止は最も安全なアプローチです。CI/CD パイプライン上でもエラーとして検知できるため、運用上も望ましい設計です。

2.  **ABANDONED 遷移**:
    *   **判定: 妥当 (Approved)**
    *   仕様書（05_foreshadowing-system.md）のステータス定義 `abandoned: 回収を断念` を実用的なワークフローとして実装に落とし込んでいます。特に `REGISTERED` (アイデア段階) からの破棄や、将来的な `REGISTERED` への復活（リサイクル）パスを用意している点は実用性が高いです。

3.  **L1 モデルとの連携**:
    *   **判定: 適切 (Approved)**
    *   `Manager` がモデルの状態遷移を管理し、副作用として可視性レベルを更新する責務配置はドメイン駆動設計的にも適切です。

4.  **将来拡張への備え (Secret)**:
    *   **判定: 整合している (Compatible)**
    *   `Expression Filter` は現状キーワードマッチのみですが、将来 `check_similarity` を実装する際に `Secret` モデルを引数として受け取り、その `get_similarity_threshold()` メソッドを呼び出す設計に自然に拡張可能です。現在の実装がその拡張を阻害する要因はありません。

## 4. 推奨事項

今後の実装フェーズに向けて、以下の点を推奨します（今回の Merge をブロックするものではありません）。

*   **Integration with Expression Filter**: 現状の `VisibilityController` は禁止キーワードリストを受け取りますが、将来的には `ExpressionFilter` サービス自体を注入（DI）するか、連携して高度なチェック（類似度判定など）を行える構造へのリファクタリングを想定しておくと良いでしょう。
*   **Global Hints Implementation**: `VisibilityController.add_hint` は現在メモリ上のみですが、作品全体に関わるヒント（世界観の根幹に関わる秘密など）を永続化する仕組み（L1 の `Settings` モデルなど）との連携を検討してください。

## 5. 総合評価

**Status**: **Approved**

品質、設計、整合性ともに非常に高いレベルで実装されています。L2 レイヤーの基盤として十分な堅牢性を持っています。
次のフェーズ（L3: Agents Integration?）への進行を承認します。
