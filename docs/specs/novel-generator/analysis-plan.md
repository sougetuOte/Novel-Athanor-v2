# Novel Generator 解析計画書

## 1. 概要

### 1.1 プロジェクトビジョン

AIとユーザーが協力して物語を作成する「半自動小説生成システム」を構築する。

**核心的な価値**:
- 完全自動ではなく、ユーザーの創造性を活かした協調的な創作
- 伏線の発生・回収を含む複層的なストーリー構造の管理
- 段階的な情報開示（読者視点/書き手視点/AI制限視点/完全秘匿）

### 1.2 解析対象

| プロジェクト | 言語 | 特徴 | 参照元 |
|-------------|------|------|--------|
| Novel-Athanor | Python + Claude Code | 設定管理、フェーズ管理 | ユーザー自作 |
| NovelWriter | Python (Tkinter) | マルチエージェント、自動生成 | GitHub |
| 302_novel_writing | TypeScript (Next.js) | Web UI、多言語対応 | GitHub |

### 1.3 解析の目的

3つのプロジェクトの長所を抽出し、以下を実現する新システムの設計基盤を構築する：

1. Novel-Athanor の設定保持能力
2. NovelWriter/302_novel_writing のストーリー生成能力
3. **新規**: 伏線管理システム（既存プロジェクトに欠けている機能）

---

## 2. 解析フロー

```
Phase 0: 事前準備 ✅ 完了
    ↓
Phase 1: Novel-Athanor 解析（Claude Code）
    ↓
Phase 2: NovelWriter 解析（Claude Code）
    ↓
Phase 3: 302_novel_writing 解析（Claude Code）
    ↓
Phase 3.5: Antigravity 解析依頼
    ↓
Phase 3.9: クロスレビュー・統合
    ↓
Phase 4: 新システム設計（複数プラン策定）
```

---

## 3. 共通解析観点（解析テンプレート）

Claude Code と Antigravity の両方が同じ観点で解析を行うための共通テンプレート。

### 3.1 アーキテクチャ観点

| 観点 | 確認事項 |
|------|----------|
| 全体構造 | ディレクトリ構成、モジュール分割、依存関係 |
| データフロー | 入力 → 処理 → 出力の流れ |
| 拡張性 | 新機能追加のしやすさ、プラグイン機構の有無 |
| 技術スタック | 言語、フレームワーク、外部ライブラリ |

### 3.2 データモデル観点

| 観点 | 確認事項 |
|------|----------|
| エンティティ | 主要なデータ構造（キャラクター、世界観、プロット等） |
| 関係性 | エンティティ間の関連（1対多、多対多） |
| 永続化 | データの保存形式（JSON、Markdown、DB等） |
| バージョン管理 | 状態変化の追跡方法 |

### 3.3 機能フロー観点

| 観点 | 確認事項 |
|------|----------|
| ユーザーインタラクション | 入力方法、UI/UX |
| 生成プロセス | AI呼び出しのタイミング、プロンプト設計 |
| 品質管理 | 整合性チェック、レビュー機能 |
| 出力形式 | 生成物のフォーマット |

### 3.4 伏線管理観点（新システム向け重点項目）

| 観点 | 確認事項 |
|------|----------|
| 伏線の定義 | 伏線をどう構造化しているか |
| 発生と回収 | 伏線の登場・解決の追跡方法 |
| 情報階層 | 読者/書き手/AIの情報アクセス制御 |
| 整合性 | 伏線の矛盾検出機能 |

---

## 4. Phase 別詳細計画

### Phase 1: Novel-Athanor 解析

**目的**: 設定管理・フェーズ管理の仕組みを深く理解する

**分割単位**:

| サブフェーズ | 対象 | 成果物 |
|-------------|------|--------|
| 1.1 アーキテクチャ | `.claude/`, `src/`, `docs/internal/` | アーキテクチャ図、コンポーネント一覧 |
| 1.2 データモデル | `vault/`, `templates/` | ER図、データスキーマ定義 |
| 1.3 機能フロー | `agents/`, `commands/`, `skills/` | 機能マトリクス、処理フロー図 |

**重点確認事項**:
- フェーズ管理の実装詳細
- 隠し設定（ネタバレ防止）の仕組み
- 整合性チェックのロジック

---

### Phase 2: NovelWriter 解析

**目的**: マルチエージェントによる自動生成の仕組みを理解する

**分割単位**:

| サブフェーズ | 対象 | 成果物 |
|-------------|------|--------|
| 2.1 エージェントアーキテクチャ | `agents/` | エージェント関係図、責務一覧 |
| 2.2 生成ロジック | `core/generation/`, `Generators/` | 生成フロー図、プロンプト設計書 |
| 2.3 品質管理 | `agents/quality/`, `agents/consistency/` | 品質基準、チェックロジック |

**重点確認事項**:
- オーケストレーターの制御フロー
- ジャンル別生成器の設計パターン
- 品質スコアリングの仕組み

---

### Phase 3: 302_novel_writing 解析

**目的**: Web UI と多言語対応の実装を理解する

**分割単位**:

| サブフェーズ | 対象 | 成果物 |
|-------------|------|--------|
| 3.1 UI/UX設計 | `src/`, `components/` | UI構成図、状態管理フロー |
| 3.2 AIインテグレーション | API呼び出し部分 | API設計、プロンプト構造 |
| 3.3 文体サンプル | `public/novelStyleType/` | ジャンル分類、サンプル構造 |

**重点確認事項**:
- リッチエディタの実装
- 章生成のワークフロー
- 文体サンプルの活用方法

---

### Phase 3.5: Antigravity 解析依頼

**目的**: 異なるAI視点での解析を取得し、バイアスを補正する

**依頼方法**:
1. `.exchange/sessions/` に解析依頼ファイルを作成
2. 命名: `2026-01-24_001_architecture.md`
3. 本計画書の「共通解析観点」を依頼内容として記載
4. 3プロジェクトそれぞれの解析を依頼

**依頼内容テンプレート**:
```markdown
## 依頼内容

以下の3プロジェクトを、添付の「共通解析観点」に基づいて解析してください。

1. docs/Novel-Athanor-main/
2. docs/NovelWriter-main/
3. docs/302_novel_writing-main/

特に以下の点に注目してください：
- 伏線管理に関連する機能の有無
- 設定の段階的開示（情報階層）の実装
- 拡張性と統合可能性
```

---

### Phase 3.9: クロスレビュー・統合

**目的**: 両者の解析結果を比較し、統合レポートを作成する

**作業内容**:

| 項目 | 内容 |
|------|------|
| 差異分析 | Claude Code vs Antigravity の解析結果の相違点を抽出 |
| 補完分析 | 一方のみが指摘した重要ポイントを統合 |
| 合意形成 | 両者が一致した評価を「確定事項」として記録 |
| 統合レポート | `docs/specs/novel-generator/analysis-report.md` に出力 |

---

### Phase 4: 新システム設計

**目的**: 解析結果を踏まえ、複数の設計プランを策定する

**成果物**:
- `docs/specs/novel-generator/design-plan-a.md`
- `docs/specs/novel-generator/design-plan-b.md`
- `docs/specs/novel-generator/design-plan-c.md`
- `docs/adr/XXXX_architecture-selection.md`（ADR）

**設計観点**:
1. **伏線管理システム**: 核心機能の設計
2. **アーキテクチャ統合**: 3プロジェクトの長所をどう組み合わせるか
3. **技術選定**: 言語、フレームワーク、UI方式

---

## 5. スケジュール目安

| Phase | 内容 | 見積もり |
|-------|------|----------|
| Phase 0 | 事前準備 | ✅ 完了 |
| Phase 1 | Novel-Athanor 解析 | 3セッション |
| Phase 2 | NovelWriter 解析 | 3セッション |
| Phase 3 | 302_novel_writing 解析 | 3セッション |
| Phase 3.5 | Antigravity 依頼 | 1セッション + 待機 |
| Phase 3.9 | クロスレビュー | 2セッション |
| Phase 4 | 新システム設計 | 3セッション |

**合計**: 約15セッション

---

## 6. 承認履歴

| 日時 | 承認者 | 内容 |
|------|--------|------|
| 2026-01-24 | ユーザー | 解析計画書の作成承認 |
| 2026-01-24 | ユーザー | **要件定義（Phase 0）承認** - Phase 1 開始可 |

---

## 7. ツール活用戦略

### 7.1 タスク永続化（セッション越え）

```bash
# プロジェクト専用のタスクリストを設定
export CLAUDE_CODE_TASK_LIST_ID=auto-novel-athanor-analysis
```

- タスクが `~/.claude/tasks/` に永続化される
- セッション再開時もタスク状態を復元
- `Ctrl+T` でタスクリスト表示

### 7.2 並列解析パターン（マルチエージェント）

```
メイン会話（統合・比較）
  ├─ Explore-A (バックグラウンド): Novel-Athanor 探索
  ├─ Explore-B (バックグラウンド): NovelWriter 探索
  └─ Explore-C (バックグラウンド): 302_novel_writing 探索
```

| エージェント | 用途 | 解析での活用 |
|-------------|------|-------------|
| **Explore** | 高速探索（読み取り専用） | 各プロジェクトの構造探索 |
| **General-purpose** | 複雑なマルチステップ | 詳細な依存関係分析 |
| **Bash** | コマンド実行 | テスト実行、ビルド確認 |

### 7.3 コンテキスト管理

- 大量コード読み取りは Explore に委譲し、メイン会話のコンテキストを節約
- `CLAUDE_AUTOCOMPACT_PCT_OVERRIDE=70` で早期圧縮を有効化
- TaskOutput Tool でバックグラウンド結果を取得

### 7.4 推奨環境変数

```bash
export CLAUDE_CODE_TASK_LIST_ID=auto-novel-athanor-analysis
export CLAUDE_AUTOCOMPACT_PCT_OVERRIDE=70
```

---

## 8. プロジェクト改造ルール

**重要**: Auto-Novel-Athanor プロジェクト自体の構成変更（`.claude/`、`docs/internal/` 等）については、以下のルールを適用する。

### 8.1 計画優先原則

プロジェクト構成の改造・修正は、以下の順序で実施する：

```
1. 現状分析（何が問題か、何を変えたいか）
    ↓
2. 変更計画の策定（どう変えるか）
    ↓
3. ユーザー承認
    ↓
4. ADR 作成（重要な決定の場合）
    ↓
5. 設計ドキュメント更新
    ↓
6. 実際のコーディング/ファイル変更
```

### 8.2 適用範囲

以下の変更には計画優先原則を適用：

- `.claude/rules/` のルール追加・修正
- `CLAUDE.md` の変更
- `docs/internal/` のプロセス定義変更
- 新規ディレクトリ構造の追加
- 状態管理方式の変更

### 8.3 例外

軽微な修正（typo、明らかなバグ修正）は即時実行可能。

---

## 9. 参照ドキュメント

- `docs/memo/最初の思いつき.md`: プロジェクト発端のアイデア
- `.exchange/README.md`: Antigravity連携プロトコル
- `docs/internal/01_REQUIREMENT_MANAGEMENT.md`: 要件管理プロセス
